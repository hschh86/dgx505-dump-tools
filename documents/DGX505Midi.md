# DGX-505 MIDI information and other miscellany

## MIDI Implementation Chart Info
Some of this information comes from the MIDI Implementation chart
located on pages 110–113 of my multilingual copy of the DGX-505 manual
(pages 105–106 of the online English copy).
See those pages for more information, such as what is *not* recognised.

Some of this is from me experimenting with what messages are transmitted.
Also refer to the official MIDI specifications and reference tables at
https://www.midi.org/specifications, 
and the specifications for Yamaha XG, which can be found unofficially at http://www.jososoft.dk/yamaha/docs_specs.htm (the DGX-505 supports the XGLite subset).

In this document, `00` denotes hexadecimal, 00 decimal.

NOTE: According to Note 1 on pg. 113, the DGX-505 functions as a tone generator
and incoming data does not affect the panel voices/settings, with the exception
of MIDI Master Tuning and Reverb/Chorus type messages.

The state of the panel can also be affected by Local ON/OFF messages and
time control Start/Stop messages (when using External Clock).

### Channels
MIDI has 16 channels, numbered 1–16 for human consumption but 0–15 (`0`–`F`)
internally. This makes talking about them a bit confusing, so I'm going to
only use the hexadecimal notation.

Since incoming data does not affect the panel settings, we can think of
two separate sets of channels:
one set for the data coming in over the MIDI port,
and the other for the data generated by the DGX-505 itself from the keyboard
or from playback when transmitted out the MIDI port.
These two sets are entirely separate and do not affect each other (see note 1
after the chart in the manual); changing the voice using messages for channel
`0` affects the voice the DGX-505 uses when sounding incoming messages
for channel `0` but does not affect the voice used when sounding from the
keyboard directly , even though the notes from the keyboard are also sent out
using channel `0`.

It can be useful to experiment by turning LOCAL off (disabling the keyboard
from activating the tone generator directly), then connecting the DGX-505
MIDI output to its input.

When output from the DGX-505, the keyboard voices use the first three channels:
* Main voice:  `0`
* Dual voice:  `1`
* Split voice: `2`

Harmony only affects the Main voice, so the Harmony notes also use `0`.

Style output uses channels `8` and `9` for percussion, and `A`, through `F`
for accompaniment.

This leaves channels 3, 4, 5, 6, 7.
Actually I'm not sure how exactly the song playback goes. Must check that out.


### Note number
Note numbers run from 0–127 (`00`–`7F`).
The lowest key on the DGX-505, A-1, is 21 (`15`), the highest, C7, is 108
(`63`). Middle C, C3, is 60 (`3C`).
The numbers transmitted are affected by the Octave and Transpose settings,
which allows all possible notes to be played on the keyboard.
Interestingly, if the shifted notes overflow past 0 or 127, they are
transposed an octave to keep them within range (True Voice range 0–127).

### Note ON
* `9n`, velocity=1–127
* velocity=0 functions as a Note OFF.

### Note OFF
Note OFF (`8n`) messages turn the notes off
but the velocity parameter is ignored.

### Pitch Bend
Pitch bend messages are transmitted when the pitch bend wheel is used.
They are of the format `En ll mm`, where `n` is the channel, and `ll mm` are
the least and most significant 7-bit bytes respectively of the 14-bit value
with a range of 0–16383, offset to represent values in the range -8192–+8191.
The neutral/unchanged value (±0) is `2000` in hexadecimal, represented as bytes `00 40` (and 8192 in decimal).
`0`/`00 00` is the value -8192, and `3FFF`/`7F 7F` is +8191. 

This conversion is performed by mido; the formula
for converting the bytes to the represented value is (`ll` + `80`×`mm`) − `200`.

The highest the physical pitch bend wheel seems to go is +8190 (`7E 7F`).

### Control Change messages
Control change messages have the form `Bn cc vv`, where `n` is the channel,
`cc` is the control, `vv` is the value.

### Setting the voice
The voice is set by specifying a bank and program.
These are listed for each voice in the back of the manual.
The bank is set with two control change messages (0 & 32 / `00` & `20`),
one for each byte; the program is set with a program change message `Cn`.
The voice does not change until the program is set.

Program change numbers are listed as 1–128, but the numbers in the
messages are actually 0–127 (`00`–`7F`). We all love conflicting
indexing conventions.

(note: there is an anomaly in the voice list.
On pg.100, the MIDI Program change for Steel Drums has an extra leading zero.
This can be ignored. The real value is 115,
which means 114 in the actual message, of course)

#### Bank Assignments
The Bank MSB for the voices supported by the DGX-505 are as follows:

* `00` (0): Regular voices (and some SFX voices)
* `40` (64): SFX voices
* `7E` (126): SFX kits
* `7F` (127): Drum kits

If the program is changed with the MSB set to any other value,
the voice will produce no sound.

With MSB `7F`, changing the program with the LSB set to any value will set to the drum kit voice with LSB 0 (but the LSB will still be recorded for if the MSB changes etc to one that supports it, it'll get used then). If there is no drum kit voice with that program, then the voice does not change at all.

With MSB `00`, changing the program with the LSB set to a value that does not match any of the voices, the program will be set to the voice that has the LSB 0. (The LSB will still be recorded etc.). There are voices for every possible program number.

With MSB `40`, changing the program with the LSB set to a value that does not match any of the voices will set to the voice that has LSB 0 and that program number (and still record the LSB etc.). If there is no voice for that program number then, the voice will produce no sound.

With MSB `7E`, both the program and LSB must match a voice (SFX kit), otherwise the voice will produce no sound.


#### Bank Select
* Control 0 sets the MSB: `Bn 00 mm`
* Control 32 sets the LSB: `Bn 20 ll`

The default bank (MSB LSB) is `00 00` for all channels except
channel `9`, for which it is `7F 00`.

#### Program Change
`Cn pp`

For example, voice no. 153, 'Harpsichord KSP', has Bank MSB 0, LSB 1,
and program 7; to set channel `0` to this voice we use the messages
`B0 00 00`, `B0 20 01`, `C0 06`.

The default program is `00`.

### Voice Volume
Control 7: `Bn 07 vv`

Controls the volume of the channel.

Default value: `64` (100)

### Voice Pan
Control 10: `Bn 0A vv`

Controls the pan of the channel, with low values being to the left and high values to the right, and `40` being the middle.

Default value: `40` (64)

### Voice Reverb Level
Control 91: `Bn 5B vv`

The send level for the Reverb effect.

Default value: `28` (40)

### Voice Chorus Level
Control 93: `Bn 5D vv`

The send level for the Chorus effect.

Default value: `00` (0)

### Pedal Sustain
Control 64:

* value 127 on pedal down: `Bn 40 7F`
* value 0 on pedal up: `Bn 40 00`

More generally, values 63 and below act like 0, 64 and above like 127.

Default value: `00` (OFF)

### Panel Sustain
Using the Panel Sustain function will emit Control 72:

* value 110 for sustain ON: `Bn 48 6E`
* value 64 for sustain OFF: `Bn 48 40`

More generally, this parameter is really the 'Release Time' according to
the chart, and can actually be set to any value `00`–`7F`:
#### Release Time
Control 72: `Bn 48 vv`

Adjusts the release of the envelope.

This is a relative adjustment, with `40` neutral (±0), so `00` is -64, `7F` is +63, and so on. Panel Sustain ON value `6E` thus represents +46.

Default value: `40` (64 / ±0 / Panel Sustain OFF)

### Other Control Change Messages
These cannot be transmitted directly from the keyboard or panel, but
may be transmitted by Harmony or Song/Style playback.

#### Modulation wheel
Control 1: `Bn 01 vv`
- Makes wobbly sounds.

Default value: `00` (0)

#### Expression
Control 11: `Bn 0B vv`

This is for voice/channel level dynamics.

Default value: `7F` (127)

#### Portamento Control
Control 84: `Bn 54 vv`

I don't think the DGX-505 supports the gradual Portamento effect; the Portamento Time cannot be set to any value and is always considered to be 0 for the purposes of Portamento control (according to the XG spec).

What this control provides is support for 'legato' (for the lack of a better term) between consecutive notes.

The value is a designation of the note, with the same values as used in note-on and note-off. If the specified note is already sounding on the channel, then on the next note-on, the note (envelope?) will transition to the note specified in the note-on message. The note-off message required to turn off the note will then be the new note, not the old one. (Consult the MIDI spec for a better explanation.)

Once a note-on message is recieved after this one, the portamento-control effect is deactivated (i.e. it only affects the one next note).

#### Harmonic Content
Control 71: `Bn 47 vv`

Another relative value, like Release time.
Adjusts the resonance.

Default value: `40` (64 / ±0)

#### Attack Time
Control 73: `Bn 49 vv`

Another relative value, like Release time.
Adjusts the attack of the envelope.

Default value: `40` (64 / ±0)

#### Brightness
Control 74: `Bn 4A vv`

Another relative value, like Release time.
Adjusts the filter cutoff frequency.

Default value: `40` (64 / ±0)

### RPN (Registed Parameter Numbers)
Used for more complicated settings, each with their own Registed Parameter
Number (represented here in the form `mm ll`). To set RPN settings, the RPN
needs to be specified using the RPN MSB/LSB messages, then the value can be
specified using the Data Entry / Increment / Decrement messages:

##### RPN MSB / LSB
* MSB set with Control 101: `Bn 65 mm`
* LSB set with Control 100: `Bn 64 ll`

Both have default values `7F`, which specifies the NULL RPN.

##### Data Entry
* MSB set with Control 6: `Bn 06 mm`
* LSB set with Control 38: `Bn 26 ll`
  - The LSB is optional and used for really fine settings;
    I'm not sure about how exactly the LSB works when the MSB is set.
  - The DGX-505 does not seem to do anything with the data entry LSB, and possibly doesn't recognise it at all.

##### Data Increment / Decrement
* MSB incremented with control 96: `Bn 60 xx`
* MSB decremented with control 97: `Bn 61 xx`
  - The `xx` bytes are ignored.

NOTE: The way that Data Increment and Decrement works for the DGX-505 is not that recommended in the MIDI specifications. 

From some experimentation, the way this seems to work is that there is an internal variable for the MSB for each channel, separate from the stored data for any RPN. This variable can be set to any value from `00` to `7F` by using the Data Entry MSB message, which then also sets the data for the currently specified RPN to the new value immediately afterward. 
Data Increment and Decrement attempt to increment or decrement this MSB variable, not the current stored data, and *then* set the data for currently specified RPN to the new value immediately afterward. If the MSB variable cannot be set to a new value (i.e. if you try to decrement when it is `00` or increment when it is `7F`), then not only does the MSB variable not change, the RPN data is not set either.

This causes some weird behaviour if you change the RPN between setting with the Data Entry MSB and using Data Increment / Decrement, so don't do that.

For example, suppose the (MSB) data for RPN `00 01` is `40`. The current RPN is `00 00`, and we use Data Entry MSB to set its value to `00`. Then, we change the RPN to `00 01` and send Data Decrement. The effect is nothing changes, because the 'MSB' variable is `00` and cannot be decremented, so RPN `00 01` still has the value `40`. However, it can be incremented; sending a Data Increment has the effect of changing RPN `00 01`'s value from `40` down to `01`!

The default value of this "MSB" variable on startup seems to be `00`.

#### Pitch Bend Range
Pitch Bend Range uses RPN `00 00`, with the value in semitones as MSB; LSB has no effect.

For example, a pitch bend range of 8 on channel `0` is set with the messages
`B0 65 00` `B0 64 00` `B0 06 08`.

The panel's Pitch Bend Range setting covers 1–12 for the three keyboard voices
on channels `0`, `1`, `2`; messages for the tone generator can use 0–24 and
set the range independently for each channel.

#### Channel Fine Tuning
Channel Fine Tuning uses RPN `00 01`.

According to the MIDI specs, this should change the tuning of a channel with a
resolution of 100/8192 cents, ranging from -100 to +100 cents (that is, ±1
semitone).

Changing the MSB definitely works, with values of `00` being a semitone lower,
`40` the default and `7F` a semitone higher.

The LSB does not seem to have any effect. I tested this by listening for beats when playing the Sine Lead on two different channels and changing the fine tuning on one of them. Incrementing the MSB gives noticeable beats, but setting the LSB to the maximum/minimum doesn't really do anything.

#### Channel Coarse Tuning
Channel Coarse Tuning uses RPN `00 02`, value as MSB only.

This changes the tuning with a resolution of 100 cents (1 semitone); LSB has no
effect. The default value is `40`; the DGX-505 supports lowering 24 semitones to
`28` and raising 24 semitones to `58`. The value can go further than this, as
can be demonstrated using increment/decrement messages, but this has no further
effect on the tuning.

#### Null
RPN `7F 7F` is the null function number, for use when you've finished setting
parameters. It disables the data entry/modification until another RPN is
selected.

### Channel Mode Messages
The DGX-505 only supports mode 3 (OMNI OFF, POLY), so the messages that
would control the omni/poly modes if they were supported are just used for
their other function of turning sound or notes off.

#### All Sound OFF
Turns all sound on a channel off. The value `xx` is ignored.

* Control 120: `Bn 78 xx`

Alternatively, the MONO/POLY mode messages do the same thing:

* Control 126: `Bn 7E xx`
* Control 127: `Bn 7F xx`

#### All Notes OFF
Turns all notes on a channel off (i.e. as if the keys were released).
The value `xx` is ignored.

* Control 123: `Bn 7B xx`

Alternatively the OMNI mode messages do the same thing:

* Control 124: `Bn 7C xx`
* Control 125: `Bn 7D xx`

#### Reset All Controllers
Control 121: `Bn 79 00`

Resets the following to default values:

* Pitch Bend, to `00 40` (±0)
* Modulation, to `00` (0)
* Expression, to `7F` (127)
* Pedal Sustain, to `00` (OFF)
* Release Time, to `40` (±0)
* Attack Time, to `40` (±0)
* Harmonic Content, to `40` (±0)
* Brightness, to `40` (±0)
* RPN, to `7F 7F` (Null)

It also cancels an active portamento control still waiting for note_on (but doesn't affect the actual note).

It does *not* affect:

* Bank and program
* RPN data
* Voice Volume
* Voice Pan
* Voice Reverb Level
* Voice Chorus Level
* Whatever the value of the Data MSB thing is internally

### Other Controls
#### Local ON/OFF
Control 122:

* Local ON: `Bn 7A 7F`
* Local OFF: `Bn 7A 00`

(The channel parameter `n` is ignored.)

Like the Pedal Sustain, values 63 and below are OFF; 64 and above are ON.

Setting Local from ON to OFF also has the effect of All Sound OFF on all
channels.


### System Real Time
#### Clock
Clock messages (`F8`) are transmitted when External Clock is OFF.

#### Commands
There are two messages implemented, Start (`FA`) and Stop (`FC`).
These are transmitted at the start and end of song/style playback.
Start and Stop messages can also be received when External Clock is ON.

### Active Sense
The instrument transmits and receives Active Sensing (`FE`) messages.

### System Exclusive

#### GM System ON
`F0 7E 7F 09 01 F7`

Sets everything to default on all channels, except for MIDI Master Tuning. Universal System Exclusive message.

* Also resets the sound on all channels.
* This affects the Reverb type and Chorus type to the "defaults" of (01)Hall1 and (---)Chorus
  - Upon instrument power on, it was set to 02(Hall2) and 1(Chorus1).
* This does *not* affect the internal Data MSB thing.

#### MIDI Master Volume
`F0 7F 7F 04 01 ll mm F7`

Changes volume of all channels. Universal System Exclusive message.

* `mm` values used, `ll` ignored.

Acts independently of channel volume.

#### MIDI Master Tuning
`F0 43 1n 27 30 00 00 mm ll cc F7`

Changes tuning of all channels. YAMAHA proprietary message.
* `mm ll` used, defaults to `08 00`. `n` and `cc` ignored.
* Only the least significant four bits of `mm` and `ll` are in fact used,
  so it's more like `F0 43 1x 27 30 00 00 xm xl xx F7`, where `x` is ignored.
  - The formula for the panel value is (`ml` − `80`), clamped to the range
    -100–+100. Inversely you can add 128 to the panel value and convert to hexadecimal to get `ml`.
  - When using the panel to adjust Tuning, messages are transmitted with all
    of the `x` in the above set to `0`.

MIDI Master Tuning acts independently of the Channel Fine/Coarse
tuning.


#### Reverb Type
`F0 43 1n 4C 02 01 00 mm ll F7`

Sets reverb type. YAMAHA proprietary XG Parameter Change message.
* `mm ll` are the MSB and LSB respectively. `n` is ignored; this is a global setting that affects the panel and all channels.
* MSB types:
  * `00`, `05`–`7F`: 10(Off)
  * `01`: 01(Hall1)
  * `02`: ---(Room)
  * `03`: ---(Stage)
  * `04`: ---(Plate)
* Specific (MSB LSB) types:
  * `01 00`: 01(Hall1)
  * `01 10`: 02(Hall2)
  * `01 11`: 03(Hall3)
  * `02 11`: 04(Room1)
  * `02 13`: 05(Room2)
  * `03 10`: 06(Stage1)
  * `03 11`: 07(Stage2)
  * `04 10`: 08(Plate1)
  * `04 11`: 09(Plate2)

It appears that when an LSB corresponds to no specific type specified above,
it is as if the LSB was `00`. This means that most fall back to the generic
effects that appear as ---(Room) etc, with the exception of Hall, which
falls back to 01(Hall1).

#### Chorus Type
`F0 43 1n 4C 02 01 20 mm ll F7`

Sets chorus type. YAMAHA proprietary XG Parameter Change message.

* `mm ll` are MSB and LSB respectively. `n` is ignored, with the same as above.
* MSB types:
  * `00`–`3F`, `44`–`7F`: 5(Off)
  * `40`: ---(Thru)
  * `41`: ---(Chorus)
  * `42`: ---(Celeste)
  * `43`: ---(Flanger)
* Specific (MSB LSB) types:
  * `42 11`: 1(Chorus1)
    - (I guess Celeste is a type of Chorus?)
  * `41 02`: 2(Chorus2)
  * `43 08`: 3(Flanger1)
  * `43 11`: 4(Flanger2)

The same LSB fallback applies.

#### XG System On
`F0 43 1n 4C 00 00 7E 00 F7`

Not documented in the manual, YAMAHA proprietary XG Parameter Change message.

This seems to behave pretty much the same as GM System ON.

This message is transmitted after the GM System ON as part of the initial dump.

#### XG All Parameter Reset
`F0 43 1n 4C 00 00 7F 00 F7`

Not documented in the manual, YAMAHA proprietary XG Parameter Change message.

This seems to behave like GM System ON, except it additionally resets MIDI Master Tuning to default. Still doesn't seem to affect the internal MSB thing.